name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # === –õ–ò–ù–¢–ò–ù–ì (pylint) ===
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pylint
        run: pip install pylint

      - name: Run pylint
        run: |
          pylint app.py test_app.py > pylint-report.txt || echo "Linting failed"

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pylint-report
          path: pylint-report.txt

  # === –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (OWASP Dependency-Check) ===
    security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create requirements.txt if missing
        run: |
          if [ ! -f requirements.txt ]; then
            echo "requests==2.31.0" > requirements.txt
            echo "flask==2.3.3" >> requirements.txt
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create reports directory
        run: mkdir -p reports

      - name: Download OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.2.0/dependency-check-9.2.0-release.zip
          unzip dependency-check-9.2.0-release.zip -d dependency-check
          chmod +x dependency-check/bin/dependency-check.sh

      - name: Run Dependency-Check
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --project "CI/CD Lab" \
            --scan "." \
            --out "reports/dependency-check-report.html" \
            --format HTML \
            --enableExperimental
        continue-on-error: true

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/dependency-check-report.html

  # === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (pytest + –º–∞—Ç—Ä–∏—Ü–∞ –≤–µ—Ä—Å–∏–π) ===
    test:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run tests
        run: |
          pytest --junitxml=reports/test-results.xml --cov=. --cov-report=xml:reports/coverage.xml || echo "Tests failed"
        continue-on-error: true  # ‚Üê –ß—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª –≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            reports/test-results.xml
            reports/coverage.xml

  # === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í SLACK –ü–†–ò –û–®–ò–ë–ö–ï ===
  notify-slack:
    runs-on: ubuntu-latest
    if: failure()
    needs: [lint, security, test]
    steps:
      - name: Send Slack alert
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: 'C09U32LSSKS'  # ‚Üê –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª
          slack-message: |
            üö® *CI/CD Pipeline Failed!*  
            Repo: ${{ github.repository }}  
            Branch: ${{ github.ref_name }}  
            Commit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}